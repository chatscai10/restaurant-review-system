<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動通知排程設定 - 分店評價查詢系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            margin: 2rem auto;
            max-width: 1200px;
            padding: 2rem;
        }
        
        .scheduler-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: none;
            margin-bottom: 2rem;
        }
        
        .time-input {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }
        
        .time-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .btn-schedule {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-schedule:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        
        .schedule-status {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }
        
        .status-active {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .frequency-option {
            margin: 0.5rem 0;
        }
        
        .time-slot {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-container">
            <!-- 標題區域 -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary mb-3">
                    <i class="fas fa-clock me-3"></i>自動通知排程設定
                </h1>
                <p class="lead text-muted">設定定時自動分析和Telegram通知</p>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-center">
                        <li class="breadcrumb-item"><a href="index.html">主頁面</a></li>
                        <li class="breadcrumb-item active">排程設定</li>
                    </ol>
                </nav>
            </div>

            <!-- 當前排程狀態 -->
            <div class="scheduler-card card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>當前排程狀態
                    </h5>
                </div>
                <div class="card-body">
                    <div id="scheduleStatus" class="schedule-status status-inactive">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6><i class="fas fa-pause-circle me-2"></i>排程未啟用</h6>
                                <p class="mb-0">目前沒有設定自動通知排程</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted">
                                    上次執行: <span id="lastExecution">從未執行</span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div id="activeSchedules" style="display: none;">
                        <h6 class="mt-3">啟用中的排程：</h6>
                        <div id="scheduleList"></div>
                    </div>
                </div>
            </div>

            <!-- 排程設定表單 -->
            <div class="scheduler-card card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-plus me-2"></i>新增排程設定
                    </h5>
                </div>
                <div class="card-body">
                    <form id="scheduleForm">
                        <!-- 排程名稱 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">排程名稱</label>
                                <input type="text" class="form-control time-input" id="scheduleName" 
                                       placeholder="例如：每日評價監控" value="每日評價監控">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">優先級</label>
                                <select class="form-control time-input" id="schedulePriority">
                                    <option value="high">高優先級</option>
                                    <option value="normal" selected>普通</option>
                                    <option value="low">低優先級</option>
                                </select>
                            </div>
                        </div>

                        <!-- 執行頻率 -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">執行頻率</label>
                            <div class="row">
                                <div class="col-md-3 frequency-option">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequency" id="hourly" value="hourly">
                                        <label class="form-check-label" for="hourly">
                                            <i class="fas fa-clock me-2"></i>每小時
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 frequency-option">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequency" id="daily" value="daily" checked>
                                        <label class="form-check-label" for="daily">
                                            <i class="fas fa-calendar-day me-2"></i>每日
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 frequency-option">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequency" id="weekly" value="weekly">
                                        <label class="form-check-label" for="weekly">
                                            <i class="fas fa-calendar-week me-2"></i>每週
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 frequency-option">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="frequency" id="custom" value="custom">
                                        <label class="form-check-label" for="custom">
                                            <i class="fas fa-cog me-2"></i>自定義
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 執行時間設定 -->
                        <div class="row mb-4">
                            <div class="col-md-4" id="timeSettings">
                                <label class="form-label fw-bold">執行時間</label>
                                <input type="time" class="form-control time-input" id="scheduleTime" value="09:00">
                                <small class="text-muted">每日在此時間自動執行</small>
                            </div>
                            <div class="col-md-4" id="weekdaySettings" style="display: none;">
                                <label class="form-label fw-bold">執行星期</label>
                                <select class="form-control time-input" id="scheduleWeekday">
                                    <option value="1">星期一</option>
                                    <option value="2">星期二</option>
                                    <option value="3">星期三</option>
                                    <option value="4">星期四</option>
                                    <option value="5">星期五</option>
                                    <option value="6">星期六</option>
                                    <option value="0">星期日</option>
                                </select>
                            </div>
                            <div class="col-md-4" id="intervalSettings" style="display: none;">
                                <label class="form-label fw-bold">間隔時間（分鐘）</label>
                                <input type="number" class="form-control time-input" id="scheduleInterval" 
                                       min="30" max="1440" value="60">
                                <small class="text-muted">最少30分鐘，最多24小時</small>
                            </div>
                        </div>

                        <!-- 通知選項 -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">通知選項</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifySuccess" checked>
                                        <label class="form-check-label" for="notifySuccess">
                                            <i class="fas fa-check-circle text-success me-2"></i>執行成功通知
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyError" checked>
                                        <label class="form-check-label" for="notifyError">
                                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>執行失敗通知
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="notifyChanges" checked>
                                        <label class="form-check-label" for="notifyChanges">
                                            <i class="fas fa-chart-line text-info me-2"></i>評分變化通知
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 監控分店選擇 -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">監控分店</label>
                            <div id="storeSelection">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="allStores" checked>
                                    <label class="form-check-label" for="allStores">
                                        <i class="fas fa-store me-2"></i>所有已設定的分店
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="specificStores">
                                    <label class="form-check-label" for="specificStores">
                                        <i class="fas fa-list me-2"></i>特定分店（從主頁面選擇）
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 操作按鈕 -->
                        <div class="text-center">
                            <button type="button" class="btn btn-schedule me-3" onclick="saveSchedule()">
                                <i class="fas fa-save me-2"></i>儲存排程設定
                            </button>
                            <button type="button" class="btn btn-outline-secondary me-3" onclick="testSchedule()">
                                <i class="fas fa-play me-2"></i>立即測試執行
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clearAllSchedules()">
                                <i class="fas fa-trash me-2"></i>清除所有排程
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 執行記錄 -->
            <div class="scheduler-card card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>執行記錄
                    </h5>
                </div>
                <div class="card-body">
                    <div id="executionLogs">
                        <p class="text-muted">暫無執行記錄</p>
                    </div>
                    <div class="text-center">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadExecutionLogs()">
                            <i class="fas fa-refresh me-2"></i>重新載入記錄
                        </button>
                    </div>
                </div>
            </div>

            <!-- 通知狀態 -->
            <div id="notificationStatus" class="schedule-status" style="display: none;"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 頻率變更處理
        document.querySelectorAll('input[name="frequency"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateTimeSettings(this.value);
            });
        });

        function updateTimeSettings(frequency) {
            const timeSettings = document.getElementById('timeSettings');
            const weekdaySettings = document.getElementById('weekdaySettings');
            const intervalSettings = document.getElementById('intervalSettings');
            
            // 隱藏所有設定
            timeSettings.style.display = 'block';
            weekdaySettings.style.display = 'none';
            intervalSettings.style.display = 'none';
            
            switch(frequency) {
                case 'hourly':
                    intervalSettings.style.display = 'block';
                    timeSettings.style.display = 'none';
                    break;
                case 'weekly':
                    weekdaySettings.style.display = 'block';
                    break;
                case 'custom':
                    intervalSettings.style.display = 'block';
                    break;
                default:
                    // daily - 只顯示時間設定
                    break;
            }
        }

        // 儲存排程設定
        async function saveSchedule() {
            const scheduleData = {
                name: document.getElementById('scheduleName').value,
                priority: document.getElementById('schedulePriority').value,
                frequency: document.querySelector('input[name="frequency"]:checked').value,
                time: document.getElementById('scheduleTime').value,
                weekday: document.getElementById('scheduleWeekday').value,
                interval: document.getElementById('scheduleInterval').value,
                notifySuccess: document.getElementById('notifySuccess').checked,
                notifyError: document.getElementById('notifyError').checked,
                notifyChanges: document.getElementById('notifyChanges').checked,
                allStores: document.getElementById('allStores').checked,
                specificStores: document.getElementById('specificStores').checked,
                createdAt: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/schedule/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('success', '排程設定儲存成功！');
                    updateScheduleStatus();
                    loadExecutionLogs();
                } else {
                    throw new Error(result.error || '儲存失敗');
                }
            } catch (error) {
                showNotification('error', '儲存排程設定失敗：' + error.message);
            }
        }

        // 測試排程執行
        async function testSchedule() {
            showNotification('info', '正在測試執行排程...');
            
            try {
                const response = await fetch('/api/schedule/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('success', '測試執行成功！結果已發送到Telegram');
                } else {
                    throw new Error(result.error || '測試失敗');
                }
            } catch (error) {
                showNotification('error', '測試執行失敗：' + error.message);
            }
        }

        // 清除所有排程
        async function clearAllSchedules() {
            if (!confirm('確定要清除所有排程設定嗎？此操作無法復原。')) {
                return;
            }

            try {
                const response = await fetch('/api/schedule/clear', {
                    method: 'DELETE'
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification('success', '所有排程已清除');
                    updateScheduleStatus();
                    document.getElementById('scheduleForm').reset();
                } else {
                    throw new Error(result.error || '清除失敗');
                }
            } catch (error) {
                showNotification('error', '清除排程失敗：' + error.message);
            }
        }

        // 載入執行記錄
        async function loadExecutionLogs() {
            try {
                const response = await fetch('/api/schedule/logs');
                const logs = await response.json();
                
                const logsContainer = document.getElementById('executionLogs');
                
                if (logs.length === 0) {
                    logsContainer.innerHTML = '<p class="text-muted">暫無執行記錄</p>';
                    return;
                }

                let logsHtml = '';
                logs.forEach(log => {
                    const statusClass = log.success ? 'text-success' : 'text-danger';
                    const statusIcon = log.success ? 'fa-check-circle' : 'fa-exclamation-circle';
                    
                    logsHtml += `
                        <div class="time-slot">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <small class="text-muted">${new Date(log.timestamp).toLocaleString('zh-TW')}</small>
                                </div>
                                <div class="col-md-6">
                                    <span class="${statusClass}">
                                        <i class="fas ${statusIcon} me-2"></i>${log.scheduleName || '未命名排程'}
                                    </span>
                                </div>
                                <div class="col-md-3 text-end">
                                    <small class="${statusClass}">${log.success ? '執行成功' : '執行失敗'}</small>
                                </div>
                            </div>
                            ${log.error ? `<div class="mt-2"><small class="text-danger">錯誤：${log.error}</small></div>` : ''}
                            ${log.result ? `<div class="mt-2"><small class="text-info">結果：平均評分 ${log.result.averageRating}⭐</small></div>` : ''}
                        </div>
                    `;
                });
                
                logsContainer.innerHTML = logsHtml;
            } catch (error) {
                console.error('載入執行記錄失敗:', error);
            }
        }

        // 更新排程狀態
        async function updateScheduleStatus() {
            try {
                const response = await fetch('/api/schedule/status');
                const status = await response.json();
                
                const statusContainer = document.getElementById('scheduleStatus');
                const activeSchedules = document.getElementById('activeSchedules');
                const scheduleList = document.getElementById('scheduleList');
                
                if (status.hasActiveSchedules) {
                    statusContainer.className = 'schedule-status status-active';
                    statusContainer.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6><i class="fas fa-play-circle me-2"></i>排程已啟用</h6>
                                <p class="mb-0">共 ${status.activeCount} 個排程正在運行</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted">
                                    上次執行: ${status.lastExecution || '從未執行'}
                                </small>
                            </div>
                        </div>
                    `;
                    
                    activeSchedules.style.display = 'block';
                    
                    let schedulesHtml = '';
                    status.schedules.forEach(schedule => {
                        schedulesHtml += `
                            <div class="time-slot">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        <strong>${schedule.name}</strong>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>${schedule.frequency} - ${schedule.time}
                                        </small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="badge bg-success">啟用中</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    scheduleList.innerHTML = schedulesHtml;
                } else {
                    statusContainer.className = 'schedule-status status-inactive';
                    statusContainer.innerHTML = `
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6><i class="fas fa-pause-circle me-2"></i>排程未啟用</h6>
                                <p class="mb-0">目前沒有設定自動通知排程</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <small class="text-muted">
                                    上次執行: 從未執行
                                </small>
                            </div>
                        </div>
                    `;
                    activeSchedules.style.display = 'none';
                }
            } catch (error) {
                console.error('載入排程狀態失敗:', error);
            }
        }

        // 顯示通知
        function showNotification(type, message) {
            const statusDiv = document.getElementById('notificationStatus');
            const className = type === 'success' ? 'status-active' : 'status-inactive';
            
            statusDiv.className = `schedule-status ${className}`;
            statusDiv.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle me-2"></i>
                    ${message}
                </div>
            `;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateScheduleStatus();
            loadExecutionLogs();
        });
    </script>
</body>
</html>