<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç¨‹è¨­å®š - ä¿®å¾©ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37); padding: 2rem; margin: 2rem auto; max-width: 900px; }
        .btn-primary { background: linear-gradient(45deg, #667eea, #764ba2); border: none; }
        .alert { border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">ğŸ› ï¸ æ’ç¨‹è¨­å®š - ä¿®å¾©ç‰ˆ</h2>
        
        <div id="notification" class="alert" style="display: none;"></div>
        
        <div class="row">
            <div class="col-md-6">
                <h4>ğŸ“… åŸºæœ¬è¨­å®š</h4>
                <div class="mb-3">
                    <label class="form-label">æ’ç¨‹åç¨±</label>
                    <input type="text" id="scheduleName" class="form-control" value="æ¯æ—¥è‡ªå‹•æŸ¥è©¢">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">åŸ·è¡Œæ™‚é–“</label>
                    <input type="time" id="scheduleTime" class="form-control" value="09:00">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">é »ç‡</label>
                    <div>
                        <input type="radio" name="frequency" value="daily" id="daily" checked>
                        <label for="daily">æ¯æ—¥</label>
                        <input type="radio" name="frequency" value="hourly" id="hourly" class="ms-3">
                        <label for="hourly">æ¯å°æ™‚</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <input type="checkbox" id="notifySuccess" checked>
                    <label for="notifySuccess">åŸ·è¡ŒæˆåŠŸé€šçŸ¥</label>
                    <br>
                    <input type="checkbox" id="notifyError" checked>
                    <label for="notifyError">åŸ·è¡Œå¤±æ•—é€šçŸ¥</label>
                </div>
                
                <button class="btn btn-primary me-2" onclick="saveSchedule()">
                    <i class="fas fa-save"></i> å„²å­˜è¨­å®š
                </button>
                <button class="btn btn-success me-2" onclick="testSchedule()">
                    <i class="fas fa-play"></i> ç«‹å³æ¸¬è©¦
                </button>
                <button class="btn btn-info" onclick="loadLogs()">
                    <i class="fas fa-refresh"></i> é‡æ–°è¼‰å…¥è¨˜éŒ„
                </button>
            </div>
            
            <div class="col-md-6">
                <h4>ğŸ“Š åŸ·è¡Œè¨˜éŒ„</h4>
                <div id="executionLogs" style="max-height: 400px; overflow-y: auto;">
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </div>
    </div>

    <script>
        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(type, message) {
            const notification = document.getElementById('notification');
            notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}`;
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // å„²å­˜æ’ç¨‹è¨­å®š - ä¿®å¾©ç‰ˆ
        async function saveSchedule() {
            try {
                const frequencyElement = document.querySelector('input[name="frequency"]:checked');
                if (!frequencyElement) {
                    showNotification('error', 'è«‹é¸æ“‡é »ç‡');
                    return;
                }
                
                const scheduleData = {
                    name: document.getElementById('scheduleName').value || 'é è¨­æ’ç¨‹',
                    frequency: frequencyElement.value,
                    time: document.getElementById('scheduleTime').value || '09:00',
                    notifySuccess: document.getElementById('notifySuccess').checked,
                    notifyError: document.getElementById('notifyError').checked,
                    createdAt: new Date().toISOString()
                };
                
                console.log('ä¿å­˜æ’ç¨‹æ•¸æ“š:', scheduleData);
                showNotification('info', 'æ­£åœ¨ä¿å­˜è¨­å®š...');
                
                const response = await fetch('/api/schedule/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });
                
                const result = await response.json();
                console.log('APIå›æ‡‰:', result);
                
                if (response.ok && result.success) {
                    showNotification('success', 'æ’ç¨‹è¨­å®šä¿å­˜æˆåŠŸï¼');
                    loadLogs(); // é‡æ–°è¼‰å…¥è¨˜éŒ„
                } else {
                    throw new Error(result.message || result.error || 'ä¿å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('ä¿å­˜éŒ¯èª¤:', error);
                showNotification('error', 'ä¿å­˜å¤±æ•—: ' + error.message);
            }
        }
        
        // æ¸¬è©¦åŸ·è¡Œ - ä¿®å¾©ç‰ˆ
        async function testSchedule() {
            try {
                showNotification('info', 'æ­£åœ¨åŸ·è¡Œæ¸¬è©¦...');
                
                const response = await fetch('/api/schedule/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                console.log('æ¸¬è©¦çµæœ:', result);
                
                if (response.ok && result.success) {
                    showNotification('success', `æ¸¬è©¦æˆåŠŸï¼å¹³å‡è©•åˆ†: ${result.result?.averageRating || 'N/A'}â­`);
                    loadLogs(); // é‡æ–°è¼‰å…¥è¨˜éŒ„
                } else {
                    throw new Error(result.message || result.error || 'æ¸¬è©¦å¤±æ•—');
                }
            } catch (error) {
                console.error('æ¸¬è©¦éŒ¯èª¤:', error);
                showNotification('error', 'æ¸¬è©¦å¤±æ•—: ' + error.message);
            }
        }
        
        // è¼‰å…¥åŸ·è¡Œè¨˜éŒ„ - ä¿®å¾©ç‰ˆ
        async function loadLogs() {
            try {
                const logsContainer = document.getElementById('executionLogs');
                logsContainer.innerHTML = '<p class="text-muted">è¼‰å…¥ä¸­...</p>';
                
                const response = await fetch('/api/schedule/logs');
                const apiData = await response.json();
                console.log('APIè¨˜éŒ„å›æ‡‰:', apiData);
                
                if (!response.ok) {
                    throw new Error('è¼‰å…¥å¤±æ•—');
                }
                
                // ä¿®å¾©ï¼šæ­£ç¢ºè§£æAPIå›æ‡‰çµæ§‹
                const logs = apiData.success && apiData.data && apiData.data.logs ? apiData.data.logs : [];
                console.log('è§£æåˆ°çš„è¨˜éŒ„:', logs);
                
                if (logs.length === 0) {
                    logsContainer.innerHTML = '<p class="text-muted">æš«ç„¡åŸ·è¡Œè¨˜éŒ„</p>';
                    return;
                }
                
                let html = '';
                logs.forEach((log, index) => {
                    // ä¿®å¾©ï¼šä½¿ç”¨æ­£ç¢ºçš„ç‹€æ…‹åˆ¤æ–·
                    const isSuccess = log.status === 'success';
                    const statusClass = isSuccess ? 'success' : 'danger';
                    const statusIcon = isSuccess ? 'check-circle' : 'times-circle';
                    
                    html += `
                        <div class="alert alert-${statusClass} alert-sm mb-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <i class="fas fa-${statusIcon} me-2"></i>
                                    <strong>${log.scheduleName || 'æœªå‘½åæ’ç¨‹'}</strong>
                                    <br>
                                    <small>${new Date(log.timestamp).toLocaleString('zh-TW')}</small>
                                    ${log.averageRating ? `<br><small>å¹³å‡è©•åˆ†: ${log.averageRating}â­</small>` : ''}
                                </div>
                                <div class="text-end">
                                    <small>${isSuccess ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}</small>
                                    ${log.executionTime ? `<br><small>${log.executionTime}ms</small>` : ''}
                                </div>
                            </div>
                            ${log.error ? `<div class="mt-2"><small class="text-danger">éŒ¯èª¤: ${log.error}</small></div>` : ''}
                        </div>
                    `;
                });
                
                logsContainer.innerHTML = html;
                showNotification('success', `è¼‰å…¥äº† ${logs.length} ç­†è¨˜éŒ„`);
                
            } catch (error) {
                console.error('è¼‰å…¥è¨˜éŒ„éŒ¯èª¤:', error);
                document.getElementById('executionLogs').innerHTML = 
                    `<div class="alert alert-danger">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
                showNotification('error', 'è¼‰å…¥è¨˜éŒ„å¤±æ•—: ' + error.message);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥è¨˜éŒ„
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¿®å¾©ç‰ˆæ’ç¨‹é é¢å·²è¼‰å…¥');
            loadLogs();
        });
    </script>
</body>
</html>