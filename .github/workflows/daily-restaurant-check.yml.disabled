name: ğŸ¤– æ¯æ—¥åˆ†åº—è©•åƒ¹è‡ªå‹•æŸ¥è©¢

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“å‡Œæ™¨1é»åŸ·è¡Œ (UTC 17:00 = å°ç£æ™‚é–“ 01:00+8)
    - cron: '0 17 * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨èª¿è©¦æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '18'
  
jobs:
  daily-restaurant-query:
    name: ğŸ“Š åŸ·è¡Œæ¯æ—¥åˆ†åº—æŸ¥è©¢
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ å®‰è£ä¾è³´
        run: |
          npm ci
          
      - name: ğŸŒ å®‰è£ç€è¦½å™¨ä¾è³´
        run: |
          # å®‰è£ Chrome ç©©å®šç‰ˆ
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          
          # é©—è­‰å®‰è£
          google-chrome --version
          
      - name: âš™ï¸ è¨­ç½®ç’°å¢ƒè®Šæ•¸
        run: |
          echo "CHROME_EXECUTABLE_PATH=/usr/bin/google-chrome" >> $GITHUB_ENV
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV
          
      - name: ğŸ” é…ç½®æŸ¥è©¢è¨­å®š
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
          QUERY_CONFIG: ${{ secrets.QUERY_CONFIG }}
        run: |
          echo "ğŸ”‘ Telegram Bot Token: ${TELEGRAM_BOT_TOKEN:0:10}..."
          echo "ğŸ“± Telegram Chat IDs: $TELEGRAM_CHAT_IDS"
          echo "ğŸ“‹ Query Config å·²è¨­ç½®"
          
      - name: ğŸš€ åŸ·è¡Œæ¯æ—¥æŸ¥è©¢
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
          QUERY_CONFIG: ${{ secrets.QUERY_CONFIG }}
        run: |
          echo "â° é–‹å§‹åŸ·è¡Œæ¯æ—¥åˆ†åº—è©•åƒ¹æŸ¥è©¢..."
          echo "ğŸ• åŸ·è¡Œæ™‚é–“: $(date)"
          
          # åŸ·è¡ŒæŸ¥è©¢è…³æœ¬
          node cloud_automation_scheduler.js
          
          echo "âœ… æŸ¥è©¢åŸ·è¡Œå®Œæˆ"
          
      - name: ğŸ“„ ä¸Šå‚³åŸ·è¡Œæ—¥èªŒ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: daily-query-logs-${{ github.run_number }}
          path: |
            scheduled_query_*.json
            *.log
          retention-days: 30
          
      - name: ğŸ“± ç™¼é€åŸ·è¡Œç‹€æ…‹é€šçŸ¥
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_IDS: ${{ secrets.TELEGRAM_CHAT_IDS }}
        run: |
          # ç™¼é€å¤±æ•—é€šçŸ¥
          curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"$(echo $TELEGRAM_CHAT_IDS | cut -d',' -f1)\",
              \"text\": \"ğŸš¨ æ¯æ—¥è‡ªå‹•æŸ¥è©¢å¤±æ•—\\nâ° å¤±æ•—æ™‚é–“: $(date)\\nğŸ”— æŸ¥çœ‹è©³æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\n\\nğŸ¤– GitHub Actions è‡ªå‹•é€šçŸ¥\"
            }"

  # å¥åº·æª¢æŸ¥ä»»å‹™
  health-check:
    name: ğŸ¥ ç³»çµ±å¥åº·æª¢æŸ¥
    runs-on: ubuntu-latest
    needs: daily-restaurant-query
    if: always()
    
    steps:
      - name: ğŸ“¥ æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ“Š ç”Ÿæˆå¥åº·å ±å‘Š
        run: |
          echo "ğŸ“‹ ç³»çµ±å¥åº·æª¢æŸ¥å ±å‘Š" > health-report.txt
          echo "åŸ·è¡Œæ™‚é–“: $(date)" >> health-report.txt
          echo "GitHub Runner: ${{ runner.os }}" >> health-report.txt
          echo "Node ç‰ˆæœ¬: $NODE_VERSION" >> health-report.txt
          echo "æŸ¥è©¢ä»»å‹™ç‹€æ…‹: ${{ needs.daily-restaurant-query.result }}" >> health-report.txt
          
          if [ "${{ needs.daily-restaurant-query.result }}" = "success" ]; then
            echo "âœ… ç³»çµ±é‹è¡Œæ­£å¸¸" >> health-report.txt
          else
            echo "âŒ ç³»çµ±éœ€è¦æª¢æŸ¥" >> health-report.txt
          fi
          
          cat health-report.txt
          
      - name: ğŸ“„ ä¿å­˜å¥åº·å ±å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_number }}
          path: health-report.txt
          retention-days: 7